---
created: '2024-04-11 17:19:49'
feishu_url: https://wk5tnvpfe7.feishu.cn/docx/VcPzdNwbooU656xEPk5c69lRn2b
modified: '2024-05-08 10:06:32'
source: feishu
title: 性能优化思路
---

性能优化思路
Redis处理线程优化
调整redis处理参数
分析redis慢查询
优化keys，调整慢sql
CONFIg get hz
CONFIG get activedefrag 
CONFIG gET lua-time-limit

CONFIg set hz 200

info
info memory

slowlog get 100 
SLOWLOG RESET
优化日志显示
ELK日志追踪，整通电话链路
kibana-6.6.1
docker pull kibana:5.6.3

docker run -d \
  --name kibana-5.6.3 \
  -p 5601:5601 \
  -e I18N_LOCALE="zh-CN" \
  -e "ELASTICSEARCH_URL=http://172.30.32.170:9200" \
  kibana:5.6.3
logstash-6.6.1
docker pull logstash:6.0.3

docker run -d --name=logstash logstash:6.6.0
docker cp logstash:/usr/share/logstash /iflytek/docker/logstash
docker run -d \
   --name logstash-6.6.0 \
  -v /iflytek/docker/logstash/config:/usr/share/logstash/config \
  -v /iflytek/docker/logstash/pipeline:/usr/share/logstash/pipeline \
  -v /iflytek/docker/logstash/data:/usr/share/logstash/data \
  -v /iflytek/docker/logstash/logs:/var/log/logstash \
  -p 5044:5044 \
  -p 9600:9600 \
  logstash:6.6.0
# aicc-log.conf
input {
  tcp {
    mode => "server"
    port => 5044
    codec => json {
             charset => "UTF-8"
         }
  }
}
filter {}
output {
  elasticsearch {
    action => "index"
    hosts  => ["172.30.32.170:9200"]
    index  => "aicc-log"
  }
}

docker logs -f -t --tail 100 e5c
 truncate -s 0 $(docker inspect --format='{{.LogPath}}' e5c)
优化日志输出信息
acd接口增加callid 链路
数据库mysql慢sql的优化
mysqldumpslow 命令的具体参数如下：

-a: 不将数字抽象成N，字符串抽象成S

-s: 是表示按照何种方式排序：

c: 访问次数
l: 锁定时间
r: 返回记录
t: 查询时间
al:平均锁定时间
ar:平均返回记录数
at:平均查询时间 （默认方式）
ac:平均查询次数
-t: 即为返回前面多少条的数据；

-g: 后边搭配一个正则匹配模式，大小写不敏感的；
分析慢sql

SHOW VARIABLES LIKE '%slow_query_log%';
SHOW GLOBAL STATUS LIKE '%Slow_queries%';
SHOW VARIABLES LIKE '%long_query_time%';

# 实时监控 

# https://www.oschina.net/p/mysqlstat


# 查询时间最慢的10个查询，可以使用如下命令：
mysqldumpslow -s t -t 10 /iflytek/mysql/mysql/mysql-slow.log

# 取出按照扫描行数最多的前10条慢查询
mysqldumpslow -s r -t 10 /iflytek/mysql/mysql/mysql-slow.log

# 取出使用最多的10条慢查询
mysqldumpslow -s c -t 10 /iflytek/mysql/mysql/mysql-slow.log

# 安装 pt-query-digest
# https://blog.csdn.net/sunon_/article/details/135283384
# https://blog.csdn.net/weixin_50401170/article/details/111216457
# 使用
# https://zhuanlan.zhihu.com/p/257975998
# https://blog.csdn.net/shaochenshuo/article/details/108636569
# https://blog.csdn.net/sunon_/article/details/135283384
pt-query-digest /iflytek/mysql/mysql/mysql-slow.log > /iflytek/mysql/mysql/mysql-slow_report.log


pt-query-digest /iflytek/mysql/mysql/mysql-slow.log --type=slowlog --filter '($event->{db} || "") =~ m/^aicc_test20240331/i' > /iflytek/mysql/mysql/mysql-slow_reportaicc_test20240331.log

# 2024-04-01 11:29:31——2024-04-08 17:18:49
# 
pt-query-digest /iflytek/mysql/mysql/mysql-slow.log --type=slowlog --filter '($event->{db} || "") =~ m/^aicc_test20240331/i' --since='2024-04-01 11:29:31' --until='2024-04-08 17:18:49' > /iflytek/mysql/mysql/mysql-slow_reportaicc_test20240331-6799.log
pt-query-digest /iflytek/mysql/mysql/mysql-slow.log --type=slowlog --filter '($event->{db} || "") =~ m/^aicc_test20240331/i' --since='2024-04-10 11:00:00' --until='2024-04-15 11:00:00' > /iflytek/mysql/mysql/mysql-slow_reportaicc_test20240331-0415.log
2024-04-10 11:00:00 -2024-04-15 11:00:00
使用Mysqlstat监控运行的Mysql
https://www.oschina.net/p/mysqlstat


---
created: '2025-07-14 15:56:12'
feishu_url: https://wk5tnvpfe7.feishu.cn/docx/I9eOdxTm9o54Y8xhEBActNXHncb
modified: '2025-07-30 09:54:45'
source: feishu
title: 数据迁移
---

数据迁移

缺少集群场景下的验证拉通
缺少有密码认证情况下的验证拉通


源es版本

使用产品

对应索引以及结构

主要功能

索引分片情况

是否有ILM策略

5.6.3

aicc

座席通话历史：aicc-test-seatcallrecord
通话联系历史：aicc-test





无

7.10.2










./config/elasticsearch.yml
network.host: 0.0.0.0
discovery.zen.ping.unicast.hosts: ["elasticsearch"]
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: false
docker compse 5.6.3
version: '3'

services:
  elasticsearch:
    image: artifacts.iflytek.com/docker-repo/library/elasticsearch:5.6.3
    container_name: elasticsearch-5.6.3
    environment:
      - cluster.name=es-5.6.3-cluster
      - node.name=node-5.6.3
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1024m -Xmx1024m"
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=false
      - xpack.security.http.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./data:/usr/share/elasticsearch/data
      - ./logs:/usr/share/elasticsearch/logs
      - ./plugins:/usr/share/elasticsearch/plugins
    ports:
      - "9220:9200"
      - "9330:9300"
    networks:
      - es-net
    user: "1000"
    command: >
      bash -c "elasticsearch-plugin install --batch x-pack &&
               elasticsearch"

networks:
  es-net:
    driver: bridge
start
docker-compose up --build -d


#在宿主机用 docker exec 切为 root 运行

docker exec -u 0 -it elasticsearch-5.6.3 bash
 
cd /usr/share/elasticsearch


bin/x-pack/users useradd myuser -p mypassword -r superuser

curl -u myuser:mypassword http://localhost:9220
5.6.3 -> 7.10.1

依赖docker、logstash、jq等基础环境命令
es7.10.1 docker compose
services:
  elasticsearch:
    image: artifacts.iflytek.com/docker-repo/library/elasticsearch:7.10.1
    container_name: elasticsearch-7.10.1
    environment:
      - discovery.type=single-node  # ✅ 必须，单节点模式
      - cluster.name=es-7.10.1-cluster
      - node.name=node-7.10.1
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml  # 可选
      - ./data:/usr/share/elasticsearch/data
      - ./logs:/usr/share/elasticsearch/logs
    ports:
      - "9221:9200"  # HTTP
      - "9331:9300"  # Transport
    networks:
      - es-net

networks:
  es-net:
    driver: bridge
增加密码验证
# 要在 Elasticsearch 7.10.1 的 Docker Compose 中 启用用户名密码认证（基本认证），你需要 开启 X-Pack Security，然后创建用户和密码。
#Elasticsearch 7.10.1 是 开源版和默认带有 Basic X-Pack（免费） 的最后一个版本之一，因此可以使用免费认证功能。
#✅ 步骤一：开启 X-Pack Security
#编辑 ./config/elasticsearch.yml 文件，添加如下内容（若已有该文件）：
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: false
#✅ 步骤二：修改 Docker Compose 配置
#在 docker-compose.yml 中的 elasticsearch 服务下增加一个默认密码配置（注意：第一次运行时加，后面再移除）：
    environment:
      - discovery.type=single-node
      - cluster.name=es-7.10.1-cluster
      - node.name=node-7.10.1
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - ELASTIC_PASSWORD=changeme  # ✅ 设置内置 elastic 用户初始密码
#例如修改后的部分如下：
    environment:
      - discovery.type=single-node
      - cluster.name=es-7.10.1-cluster
      - node.name=node-7.10.1
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - ELASTIC_PASSWORD=changeme
#✅ 步骤三：首次启动后测试登录
curl -u elastic:changeme http://localhost:9221
#你应该看到正常返回的集群信息。
#✅ 步骤四：可选 - 添加其他用户
#你可以进入容器创建更多用户：
docker exec -it elasticsearch-7.10.1 /bin/bash

# 使用 elastic 用户认证
bin/elasticsearch-users useradd myuser -p mypassword -r superuser
#然后你可以用新用户认证：
curl -u myuser:mypassword http://localhost:9221
#✅ 步骤五：生产建议（安全加固）
#把 ELASTIC_PASSWORD 设置移除，改为使用自定义创建用户。
#可以挂载证书并启用 https。
#不对公网暴露端口或使用 Nginx + 基于 token 或 IP 白名单。
#✅ 示例最终结构目录
.
├── config
│   └── elasticsearch.yml
├── data
├── logs
└── docker-compose.yml
源索引导出
curl -XGET "http://172.30.10.100:9200/aicc-test-seatcallrecord143/_mapping?pretty" > aicc-test-seatcallrecord143.json
导入7.10.2
# 删除type
curl -XPUT "http://172.30.32.170:9221/aicc-test-seatcallrecord143" -H 'Content-Type: application/json' -d'{
        "mappings": {
                "properties": {
                        "businessTagLists": {
                                "properties": {
                                        "id": {
                                                "type": "keyword"
                                        },
                                        "name": {
                                                "type": "keyword"
                                        },
                                        "path": {
                                                "type": "keyword"
                                        }
                                }
                        },
                        "businessTags": {
                                "properties": {
                                        "id": {
                                                "type": "text",
                                                "fields": {
                                                        "keyword": {
                                                                "type": "keyword",
                                                                "ignore_above": 256
                                                        }
                                                }
                                        },
                                        "name": {
                                                "type": "text",
                                                "fields": {
                                                        "keyword": {
                                                                "type": "keyword",
                                                                "ignore_above": 256
                                                        }
                                                }
                                        },
                                        "path": {
                                                "type": "text",
                                                "fields": {
                                                        "keyword": {
                                                                "type": "keyword",
                                                                "ignore_above": 256
                                                        }
                                                }
                                        }
                                }
                        },
                        "callDuration": {
                                "type": "long"
                        },
                        "callEndReason": {
                                "type": "keyword"
                        },
                        "callEndReasonDes": {
                                "type": "keyword"
                        },
                        "callEndTime": {
                                "type": "date",
                                "format": "yyyy-MM-dd HH:mm:ss"
                        },
                        "callId": {
                                "type": "keyword"
                        },
                        "callIn": {
                                "type": "boolean"
                        },
                        "callPhoneNo": {
                                "type": "keyword"
                        },
                        "callStartTime": {
                                "type": "date",
                                "format": "yyyy-MM-dd HH:mm:ss"
                        },
                        "callType": {
                                "type": "keyword"
                        },
                        "city": {
                                "type": "keyword"
                        },
                        "createTime": {
                                "type": "date",
                                "format": "yyyy-MM-dd HH:mm:ss"
                        },
                        "customerId": {
                                "type": "keyword"
                        },
                        "customerName": {
                                "type": "keyword"
                        },
                        "description": {
                                "type": "keyword"
                        },
                        "doc": {
                                "properties": {
                                        "callDuration": {
                                                "type": "long"
                                        }
                                }
                        },
                        "duty": {
                                "type": "keyword"
                        },
                        "explicitNumber": {
                                "type": "keyword"
                        },
                        "firstSeatRouter": {
                                "type": "keyword"
                        },
                        "firstServerRouter": {
                                "type": "keyword"
                        },
                        "handleType": {
                                "type": "keyword"
                        },
                        "hangUpReason": {
                                "type": "keyword"
                        },
                        "hangupIvr": {
                                "type": "text",
                                "fields": {
                                        "keyword": {
                                                "type": "keyword",
                                                "ignore_above": 256
                                        }
                                }
                        },
                        "id": {
                                "type": "keyword"
                        },
                        "inSide": {
                                "type": "boolean"
                        },
                        "manualservice": {
                                "type": "keyword"
                        },
                        "myCallInfoFlag": {
                                "type": "keyword"
                        },
                        "myd": {
                                "type": "keyword"
                        },
                        "orgCode": {
                                "type": "keyword"
                        },
                        "phoneCode": {
                                "type": "keyword"
                        },
                        "phoneNo": {
                                "type": "keyword"
                        },
                        "province": {
                                "type": "keyword"
                        },
                        "queueDuration": {
                                "type": "long"
                        },
                        "queueTime": {
                                "type": "keyword"
                        },
                        "recordFile": {
                                "type": "text",
                                "fields": {
                                        "keyword": {
                                                "type": "keyword",
                                                "ignore_above": 256
                                        }
                                }
                        },
                        "repeatCall": {
                                "type": "boolean"
                        },
                        "ringTime": {
                                "type": "long"
                        },
                        "rushCallId": {
                                "type": "keyword"
                        },
                        "rushDestCallRecordId": {
                                "type": "keyword"
                        },
                        "seatCallId": {
                                "type": "keyword"
                        },
                        "seatName": {
                                "type": "keyword"
                        },
                        "seatNo": {
                                "type": "keyword"
                        },
                        "seatQueueId": {
                                "type": "keyword"
                        },
                        "seatTypeValue": {
                                "type": "text",
                                "fields": {
                                        "keyword": {
                                                "type": "keyword",
                                                "ignore_above": 256
                                        }
                                }
                        },
                        "skillGroupId": {
                                "type": "keyword"
                        },
                        "skillGroupName": {
                                "type": "keyword"
                        },
                        "status": {
                                "type": "keyword"
                        },
                        "vipFlag": {
                                "type": "keyword"
                        },
                        "voiceId": {
                                "type": "text",
                                "fields": {
                                        "keyword": {
                                                "type": "keyword",
                                                "ignore_above": 256
                                        }
                                }
                        }
                }
        }
}'
logstash compose
services:
  logstash:
    image: artifacts.iflytek.com/docker-repo/library/logstash:5.6.3  # 使用与源ES兼容的版本
    container_name: logstash-es-migration
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
      - ./logs:/usr/share/logstash/logs  # 新增：日志文件映射到本地
    environment:
        LS_JAVA_OPTS: "-Xmx1g -Xms1g"
        pipeline.workers: 4
        pipeline.batch.size: 5000
        pipeline.batch.delay: 50
        queue.type: persisted
        queue.max_bytes: 1gb
    command: logstash -f /usr/share/logstash/pipeline/logstash.conf
    networks:
      - es-net

networks:
  es-net:
    driver: bridge
logstash_template.conf
input {
  elasticsearch {
    hosts => ["%{SOURCE_ES}"]  # 源集群
    index => "%{INDEX}"
    # 动态时间范围查询（按 callStartTime 过滤，从新到旧）
    query => '{"query": {"range": {"callStartTime": {"gte": "%{START_TIME}", "lte": "%{END_TIME}", "format": "yyyy-MM-dd HH:mm:ss"}}}}'
    scroll => "10m"
    size => 2000  # 每批处理量（根据集群性能调整）
    docinfo => true  # 开启 docinfo 才能获取 _id
    docinfo_target => "[@metadata]"  # 5.6.3 支持这么写
  }
}
# filter {
#   mutate {
#     add_field => { "_id" => "%{[@metadata][_id]}" }  # 显式提取
#   }
# }
output {
  elasticsearch {
    hosts => ["%{TARGET_ES}"]  # 目标集群
    index => "%{INDEX}"
    document_type => "%{TYPE}"
    document_id => "%{[@metadata][_id]}"  # 已验证：id 与源 _id 一致
    manage_template => false
  }

  # 输出迁移统计到日志文件（每批汇总用）
  file {
    path => "/usr/share/logstash/logs/%{BATCH_STATS_FILE}"
    codec => line {
      format => '{"batch_time": "%{+yyyy-MM-dd HH:mm:ss}", "start_time": "%{START_TIME}", "end_time": "%{END_TIME}", "document_id": "%{[@metadata][_id]}", "status": "success"}'
    }
  }
}
migrate_batch.sh
#!/bin/bash

# 配置参数（按照实际情况调整）
SOURCE_ES="http://172.30.32.170:9220"
TARGET_ES="http://172.30.32.170:9221"
INDEX="aicc-test-seatcallrecord143" #需要迁移的索引
SOURCE_TYPE="SEATCALLRECORD" # 源es 5.X索引文档类型
TIME_FIELD="callStartTime"  # 时间字段（按实际字段调整）
BATCH_DAYS=30  # 每批迁移30天数据
TOTAL_MONTHS=2  # 总迁移6个月数据
END_DATE="2025-06-15 23:59:59"  # 最新数据时间


# es7.X版本，固定
TYPE="_doc" # 索引类型字段
# 日志目录
BASE_DIR="./logs"
LOG_FILE="$BASE_DIR/migration_batch.log"
LOGSTASH_CONF_TEMPLATE="./logstash_template.conf"
LOGSTASH_CONF="./logstash.conf"

# 初始化时间范围（从当前时间倒推半年）
# END_DATE=$(date +"%Y-%m-%d 23:59:59")
START_DATE=$(date -d "-$TOTAL_MONTHS months" +"%Y-%m-%d 00:00:00")
# 时间戳
START_DATE_TS=$(date -d "$START_DATE" +%s)
TOTAL_COUNT=0
# 检查依赖工具是否存在
check_dependency() {
    if ! command -v $1 &> /dev/null; then
        echo "错误: 工具 '$1' 未安装。请先安装 $2"
        exit 1
    fi
}

# 检查必要工具
check_dependency "curl" "curl (通常已预装或使用 brew install curl)"
check_dependency "jq" "jq (brew install jq)"
check_dependency "docker" "Docker (https://www.docker.com/)"
check_dependency "docker compose" "Docker Compose (通常随Docker一起安装)"
check_dependency "wc" "coreutils (通常已预装)"
# 初始化日志
mkdir -p "$BASE_DIR"
touch "$LOG_FILE"
echo "===== 迁移批次记录开始（$(date)） =====" >> $LOG_FILE
echo "总时间范围：$START_DATE 至 $END_DATE，每批 $BATCH_DAYS 天" >> $LOG_FILE
# 导出源索引映射
echo "===== 开始导出源索引映射 =====" >> $LOG_FILE
MAPPING_FILE="$BASE_DIR/$INDEX.json"
curl -s -XGET "$SOURCE_ES/$INDEX/_mapping?pretty" -o $MAPPING_FILE
if [ $? -ne 0 ] || [ ! -s $MAPPING_FILE ]; then
    echo "映射导出失败或文件为空" >> $LOG_FILE
    exit 1
fi
echo "映射导出成功：$MAPPING_FILE" >> $LOG_FILE
# 添加JSON结构转换步骤
echo "===== 开始转换映射结构 =====" >> $LOG_FILE
MAPPING_FILE="$BASE_DIR/${INDEX}_mapping.json"
TMP_MAPPING_FILE="$BASE_DIR/${INDEX}_transformed_mapping.json"
# 使用变量替换硬编码的索引名和类型
jq --arg idx "$INDEX" --arg type "$SOURCE_TYPE" '.[$idx].mappings[$type]' "$MAPPING_FILE" > "$TMP_MAPPING_FILE"
if [ $? -ne 0 ] || [ ! -s $TMP_MAPPING_FILE ]; then
    echo "JSON结构转换失败或文件为空" >> $LOG_FILE
    exit 1
fi
echo "映射结构转换成功：$TMP_MAPPING_FILE" >> $LOG_FILE
# 导入映射到目标索引
echo "===== 开始导入映射到目标索引 =====" >> $LOG_FILE
 # 检查目标索引是否存在
INDEX_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_ES/$INDEX")
if [ "$INDEX_EXISTS" -eq 200 ]; then
    echo "目标索引 $INDEX 已存在." >> $LOG_FILE
else
    curl -s -XPUT "$TARGET_ES/$INDEX" -H 'Content-Type: application/json' -d @$TMP_MAPPING_FILE
    if [ $? -ne 0 ]; then
        echo "映射导入失败" >> $LOG_FILE
        exit 1
    fi
    echo "映射导入成功" >> $LOG_FILE
fi

# 初始化循环变量
current_end="$END_DATE"

while true; do
    # ===== 1. 计算当前批次的起始时间 =====
    current_end_ts=$(date -d "$current_end" +%s)
    current_start_ts=$((current_end_ts - BATCH_DAYS * 86400))
    
    if [ $current_start_ts -lt $START_DATE_TS ]; then
        current_start_ts=$START_DATE_TS
    fi
    
    current_start=$(date -d "@$current_start_ts" +"%Y-%m-%d %H:%M:%S")
    
    echo "===== 开始迁移批次：$current_start 至 $current_end =====" >> $LOG_FILE

    BATCH_ID=$(date -d "$current_start" +"%Y%m%d%H%M%S")
    BATCH_STATS_NAME="batch_stats_$BATCH_ID.json"
    # logstash本身为宿主机目录
    BATCH_STATS_FILE=$BASE_DIR/$BATCH_STATS_NAME
    # ===== 4. 记录迁移统计 =====
    if [ ! -f "$BATCH_STATS_FILE" ]; then
        touch "$BATCH_STATS_FILE"
        echo "初始化迁移统计文件" >> $LOG_FILE
    fi
    if [ -f "$BATCH_STATS_FILE" ]; then
        > "$BATCH_STATS_FILE"
        echo "$(date) 已清空历史统计文件" >> $LOG_FILE
    fi
    chmod -R 777 $BASE_DIR
    # ===== 2. 替换Logstash配置文件变量 =====
    sed -e "s|%{START_TIME}|$current_start|g" \
        -e "s|%{END_TIME}|$current_end|g" \
        -e "s|%{BATCH_STATS_FILE}|$BATCH_STATS_NAME|g" \
        -e "s|%{SOURCE_ES}|$SOURCE_ES|g" \
        -e "s|%{INDEX}|$INDEX|g" \
        -e "s|%{TARGET_ES}|$TARGET_ES|g" \
        -e "s|%{TYPE}|$TYPE|g" \
        "$LOGSTASH_CONF_TEMPLATE" > "$LOGSTASH_CONF"    

    # ===== 3. 启动Logstash迁移当前批次 =====
    BATCH_START_TS=$(date +%s)
    docker compose up -d logstash
    CONTAINER_ID=$(docker compose ps -q logstash)
    echo "Logstash容器ID: $CONTAINER_ID，开始迁移..." >> $LOG_FILE
    
    # 等待迁移完成
    docker wait "$CONTAINER_ID"
    LOGSTASH_EXIT_CODE=$?
    BATCH_END_TS=$(date +%s)
    BATCH_DURATION=$((BATCH_END_TS - BATCH_START_TS))
    
    if [ $LOGSTASH_EXIT_CODE -ne 0 ]; then
        echo "批次 $current_start 至 $current_end 迁移失败，退出码: $LOGSTASH_EXIT_CODE" >> $LOG_FILE
        exit $LOGSTASH_EXIT_CODE
    fi
    BATCH_COUNT=$(wc -l < "$BATCH_STATS_FILE")
    TOTAL_COUNT=$((TOTAL_COUNT + BATCH_COUNT))
    if [ $BATCH_DURATION -lt 0 ]; then
        echo "批次 $current_start 至 $current_end 耗时为负：$BATCH_DURATION 秒，请检查时间逻辑。" >> $LOG_FILE
    fi
    
    echo "批次 $current_start 至 $current_end：迁移 $BATCH_COUNT 条数据，耗时 $BATCH_DURATION 秒，结果：$BATCH_STATS_FILE" >> $LOG_FILE
    
    # ===== 5. 随机抽查验证 =====
    if [ $BATCH_COUNT -gt 0 ]; then
        SUCCESS=0
        FAILED=0

        # 提取当前批次的 document_id 并随机抽取最多 10 个
        RANDOM_IDS=$(jq -r '.document_id' "$BATCH_STATS_FILE" | shuf | head -10)
        ID_COUNT=$(echo "$RANDOM_IDS" | wc -l)

        echo "[验证开始] 批次 $current_start 至 $current_end，共需验证 $ID_COUNT 个ID" >> $LOG_FILE

        while read -r id; do
            VAL_START=$(date +%s)
            if curl -s "$TARGET_ES/$INDEX/$TYPE/$id" | jq -e '.found == true' > /dev/null; then
                echo "[验证成功] ID $id 耗时 $(( $(date +%s) - VAL_START )) 秒" >> $LOG_FILE
                SUCCESS=$((SUCCESS + 1))
            else
                echo "[验证失败] ID $id 耗时 $(( $(date +%s) - VAL_START )) 秒" >> $LOG_FILE
                FAILED=$((FAILED + 1))
            fi
        done <<< "$RANDOM_IDS"

        if [[ $((SUCCESS + FAILED)) -gt 0 ]]; then
            RATE=$(( SUCCESS * 100 / (SUCCESS + FAILED) ))
            echo "[验证统计] 成功 $SUCCESS 条，失败 $FAILED 条，成功率 $RATE%" >> $LOG_FILE
        else
            echo "[验证警告] 无有效验证样本（可能日志格式不包含 document_id）" >> $LOG_FILE
        fi
    else
        echo "批次 $current_start 至 $current_end：无数据迁移，跳过验证步骤" >> $LOG_FILE
    fi
    # ===== 6. 判断是否迁移完成 =====
    if [ $current_start_ts -le $START_DATE_TS ]; then
        echo "=====总时间范围：$START_DATE 至 $END_DATE 所有批次迁移完成（$(date)），总计迁移 $TOTAL_COUNT 条数据 =====" >> $LOG_FILE
        exit 0
    fi
    
    # ===== 7. 更新为下一批次 =====
    current_end=$(date -d "@$((current_start_ts - 1))" +"%Y-%m-%d %H:%M:%S")
done

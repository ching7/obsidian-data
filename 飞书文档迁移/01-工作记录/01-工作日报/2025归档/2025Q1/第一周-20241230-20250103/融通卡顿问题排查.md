---
created: '2025-01-02 09:57:31'
feishu_url: https://wk5tnvpfe7.feishu.cn/docx/Fssvdb1E7oGUrUxZur6cXmfYnMc
modified: '2025-01-02 17:05:33'
source: feishu
title: 融通卡顿问题排查
---

融通卡顿问题排查
目前系统卡顿的问题原因
初步分析：IM 、AICC 天翼云
主要原因：存量历史数据累积，数据库性能下降（目前单表最高数据量达到2000W级别，影响查询效率）
200W*800W  = > mysql
9点：首页排名、报表定时（15、30、60）
识别到：call  保留2天，
其余：
由于查询缓慢导致的异常场景，代码异常保护不全面
其余的非卡顿问题
对于座席
影响查询：
9-9:30
11点，
15点
数据迁移的影响（13-27号）
aicc的通话历史、录音、明细报表等，im的联系历史（2000w）、聊天记录等相关数据仅保留近半年的数据
相关历史数据迁移到历史表，需要可以运维通过数据库查询
统计报表相关历史数据不受影响
座席使用：投诉场景、半-n年前通话历史、录音、明细报表
组长：分析去年会话，目前使用明细表
会话标签统计无法使用：数据缺失
如果业务不接受我们优化的技术方案是什么（2年，5-10s）
代码逻辑更新（aicc、im）
修改缓存触发逻辑
优化关联查询逻辑
（aicc\im）增加历史表、历史数据查询功能，将热数据与冷数据进行拆分=工作量大（13号之前）
通话历史、联系历史、明细报表。通话页
前端页面
后端服务
数据库增加分区，按照月份、年份，进行数据分区，提高查询效率=工作量中等


语音经常使用：通话，只查询近半年
IM经常使用：在线，只查询近半年



座席经常使用的页面仅查询近半年的，其他页面保留全部数据=是否可行
后续方案评估，交互=13号是否可达，具体的交互页面设计
原有相关的表（call_record）变更热数据表：相关表仅存储半年内的热数据，提供给
工作台（aicc）
通话（aicc）
在线服务（im）
以上界面相关原有查询全量数据，改为查热数据表
新增冷数据表：相关页面提供冷、热数据分别查询，提供给
通话历史（aicc\im）
联系历史（aicc\im）
明细报表（aicc）
改动点
数据冷热分表调整（运维工作）
目前在热数据表的历史数据，上线前按照分表逻辑，迁移历史数据到冷数据表
可以将相关原表改名为冷数据表(call_record_history)
从原相关表中抽取仅6个月的数据到新的热数据表(call_record)
数据分表的影响范围
按照原有逻辑写入热数据表
报表同步按照原有逻辑同步热数据表
对接三方系统按照原有逻辑按照热数据表进行同步、对接
定时任务（sql脚本）
采用mysql的定时任务：每天凌晨从热数据表中，同步半年前的数据到冷数据表（每天同步一天，1月2号，7月2号）的。同步成功后从热数据表中删除
限制查询条件
热数据只查询仅半年的
冷库半年以前
冷库存全量
有一天的时间差
双写
页面：提供冷、热数据分开查询的按钮。后台接口区分查询表，相关接口调整
通话历史、联系历史（aicc）：已经查询es，目前查询效率满足
查询详情的时候需要区分热数据与历史数据
通话历史、联系历史（im）：
已经查询es，目前查询效率满足
明细报表（aicc），5张：提供冷、热数据分开查询的按钮。

改造方案确认：陈亚男
工作台（aicc）、通话（aicc）、在线服务（im）三个菜单座席经常使用菜单数据范围设置为：半年
语音明细报表调整查询方式是否认可，新增按钮区分冷热数据查询。涉及明细数据查询、下载
确认aicc、im涉及到的冷热数据库表，整理改造点和改造方案以及工作量，按照13号提供版本评估是否可达（明天输出）
阮书锦（通话页、工作台、通话历史详情）
汤楠楠（明细报表）
许焰（IM）
各位好：
针对近期建信融局点每天9:00-9:30的部分卡顿问题。目前初步定位：
存量历史数据累积，数据库性能下降（目前单表最高数据量达到2000W级别，影响查询效率）

解决方案如下：
临时解决方案：
调整、删除部分后台定时任务表，删除部分用于报表数据计算的表历史数据
效果：在24年12月31号完成调整，目前观察25年的1月2号9:00-9:30的场景，目前应用侧卡顿情况缓解，无卡顿情况
后续解决方案（1月13号前）：
进行冷热数据分离处理，目前暂定明天1月3号输出具体改造方案，进行工作量排期
调整部分代码查询逻辑、定时任务处理逻辑
具体代办任务如下：
1.改造方案确认：陈亚男
    a. 工作台（aicc）、通话（aicc）、在线服务（im）三个菜单座席经常使用菜单数据范围设置为：半年
    b. 语音明细报表调整查询方式是否认可，新增按钮区分冷热数据查询。涉及明细数据查询、下载
2. 确认aicc、im涉及到的冷热数据库表，整理改造点和改造方案以及工作量，按照13号提供版本评估是否可达（明天1月3号输出）
    a. 阮书锦（通话页、工作台、通话历史详情）
    b. 汤楠楠（明细报表）
    c. 许焰（IM）
